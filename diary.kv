#:set C_BG (0.05, 0.066, 0.09, 1)
#:set C_SURFACE (0.086, 0.105, 0.133, 1)
#:set C_BORDER (0.188, 0.211, 0.239, 1)
#:set C_ACCENT (0.345, 0.651, 1.0, 1)
#:set C_TEXT_MAIN (0.788, 0.82, 0.851, 1)
#:set C_TEXT_SEC (0.545, 0.58, 0.62, 1)
#:set C_BTN_OK (0.137, 0.525, 0.211, 1)

#:import DampedScrollEffect kivy.effects.dampedscroll.DampedScrollEffect
#:import SwipeBox widgets.SwipeBox
#:import DiaryEntryItemCard widgets.DiaryEntryItemCard
#:import WindowManager screens.WindowManager
#:import HomeScreen screens.HomeScreen
#:import DiaryScreen screens.DiaryScreen
#:import DetailScreen screens.DetailScreen
#:import QuestionEditorScreen screens.QuestionEditorScreen
#:import DayPage screens.DayPage

<FlatButton@Button>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    color: 1, 1, 1, 1
    font_size: '16sp'
    bold: True
    canvas.before:
        Color:
            rgba: C_BTN_OK if self.state == 'normal' else (0.16, 0.58, 0.24, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        Color:
            rgba: (1, 1, 1, 0.1)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

<GhostButton@Button>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    color: C_ACCENT
    font_size: '16sp'
    canvas.before:
        Color:
            rgba: (0.1, 0.1, 0.1, 0) # Transparent usually
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]

WindowManager:
    HomeScreen:
    QuestionEditorScreen:
    DetailScreen:

#:import NavButton widgets.NavButton
#:import BottomNavBar widgets.BottomNavBar
#:import PlaceholderDisplay screens.PlaceholderDisplay
#:import HomeDashboard screens.HomeDashboard
#:import StatCard widgets.StatCard
#:import RecentEntryItem widgets.RecentEntryItem
#:import HeatmapCell widgets.HeatmapCell

<NavButton>:
    orientation: 'vertical'
    size_hint_y: 1
    padding: [0, 8]
    
    # Icon Container using Material Icons Font
    Label:
        id: icon_d
        text: 
            {'home': u"\ue88a", 'map': u"\ue55b", 'settings': u"\ue8b8", 'profile': u"\ue7fd", 'center': u"\ue3c9"}.get(root.icon_type, "")
        font_name: 'assets/MaterialIcons-Regular.ttf'
        font_size: root.icon_size + sp(0) # Bind to property
        color: 
            (1, 1, 1, 1) if root.icon_type == 'center' else (C_ACCENT if root.state == 'down' else C_TEXT_SEC)
        size_hint: (None, None)
        size: (40, 40)
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        
        canvas.before:
            # CENTER FAB GLOW BACKGROUND
            Color:
                rgba: C_ACCENT if root.icon_type == 'center' else (0,0,0,0)
            Ellipse:
                pos: (self.center_x - 28, self.center_y - 28) if root.icon_type == 'center' else (0,0)
                size: (56, 56) if root.icon_type == 'center' else (0,0)


<PlaceholderDisplay>:
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: root.text
            color: C_TEXT_SEC
            font_size: '20sp'

# ... (Previous definitions)

<StatCard>:
    orientation: 'vertical'
    padding: 15
    spacing: 5
    canvas.before:
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
    
    Label:
        text: root.icon
        font_name: 'assets/MaterialIcons-Regular.ttf'
        font_size: '24sp'
        color: root.accent_color
        size_hint_y: None
        height: '30dp'
        halign: 'left'
        text_size: self.size

    Label:
        text: root.value
        font_size: '22sp'
        bold: True
        color: C_TEXT_MAIN
        halign: 'left'
        text_size: self.size
    
    Label:
        text: root.title
        font_size: '12sp'
        color: C_TEXT_SEC
        halign: 'left'
        text_size: self.size

<RecentEntryItem>:
    size_hint_y: None
    height: '60dp'
    padding: [10, 5]
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.03) if self.state == 'normal' else (1, 1, 1, 0.08)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8]
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 2
        Label:
            text: root.date_text
            font_size: '13sp'
            color: C_ACCENT
            bold: True
            text_size: self.size
            halign: 'left'
            valign: 'middle'
        Label:
            text: root.preview_text
            font_size: '14sp'
            color: C_TEXT_MAIN
            text_size: self.size
            halign: 'left'
            valign: 'middle'
            shorten: True
            shorten_from: 'right'

<HeatmapCell>:
    size_hint: (None, None)
    size: (12, 12)
    canvas.before:
        Color:
            rgba: root.color_val
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [2]

<HomeDashboard>:
    name: "home_tab"
    today_date: ""
    
    BoxLayout:
        orientation: 'vertical'
        padding: [20, 20, 20, 20]
        spacing: 20
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            orientation: 'horizontal'
            
            BoxLayout:
                orientation: 'vertical'
                spacing: 2
                Label:
                    text: "Good Morning,"
                    font_size: '16sp'
                    color: C_TEXT_SEC
                    text_size: self.size
                    halign: 'left'
                Label:
                    text: root.date_display
                    font_size: '24sp'
                    bold: True
                    color: C_TEXT_MAIN
                    text_size: self.size
                    halign: 'left'

        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 0
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 25
                padding: [0, 10, 0, 80] # Bottom padding for navbar space

                # --- Heatmap Section ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: '140dp'
                    spacing: 10
                    
                    Label:
                        text: "Contribution Graph"
                        size_hint_y: None
                        height: '20dp'
                        font_size: '14sp'
                        color: C_TEXT_SEC
                        text_size: self.size
                        halign: 'left'

                    ScrollView:
                        do_scroll_x: True
                        do_scroll_y: False
                        size_hint_y: None
                        height: '110dp'
                        bar_width: 0
                        
                        BoxLayout:
                            id: heatmap_container
                            orientation: 'horizontal'
                            size_hint_x: None
                            width: self.minimum_width
                            spacing: 4
                            padding: [5, 5]

                # --- Stats Section ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: '110dp' # Height of cards
                    spacing: 10

                    Label:
                        text: "Overview"
                        size_hint_y: None
                        height: '20dp'
                        font_size: '14sp'
                        color: C_TEXT_SEC
                        text_size: self.size
                        halign: 'left'
                    
                    BoxLayout:
                        spacing: 15
                        
                        StatCard:
                            id: stat_streak
                            title: "Current Streak"
                            icon: u"\ue52e" # fire? or timeline?
                            value: "0"
                            accent_color: (1.0, 0.6, 0.2, 1) # Orange
                        
                        StatCard:
                            id: stat_total
                            title: "Total Entries"
                            icon: u"\ue865" # book
                            value: "0"
                            accent_color: (0.2, 0.8, 0.2, 1) # Green

                        StatCard:
                            id: stat_active
                            title: "Most Active"
                            icon: u"\ue916" # date_range
                            value: "-"
                            accent_color: (0.4, 0.4, 0.9, 1) # Blue



<HomeScreen>:
    name: "home"
    
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # Content Area
        ScreenManager:
            id: content_manager
            
            HomeDashboard:
                id: home_tab_screen
            
            PlaceholderDisplay:
                name: "map_tab"
                text: "City Map\n(Coming Soon)"
            
            DiaryScreen:
                name: "diary"

            PlaceholderDisplay:
                name: "settings_tab"
                text: "Settings\n(Coming Soon)"
            
            PlaceholderDisplay:
                name: "profile_tab"
                text: "Profile\n(Coming Soon)"

        # Bottom Navigation Bar
        BoxLayout:
            size_hint_y: None
            height: '80dp'
            padding: [15, 10, 15, 20] # Extra bottom padding for "floating" feel on mobile
            spacing: 0
            canvas.before:
                Color:
                    rgba: (0.086, 0.105, 0.133, 0.98) # Slight transparency C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: (1, 1, 1, 0.05) # Very subtle top highlight
                Line:
                    points: [self.x, self.y + self.height, self.width, self.y + self.height]
                    width: 1
            
            NavButton:
                icon_type: 'home'
                group: 'nav'
                state: 'down' # Default active
                on_release: root.navigate_to('home_tab')
            
            NavButton:
                icon_type: 'map'
                group: 'nav'
                on_release: root.navigate_to('map_tab')
            
            NavButton:
                icon_type: 'center'
                group: 'nav'
                size_hint_x: 1.2
                on_release: root.navigate_to('diary')

            NavButton:
                icon_type: 'settings'
                group: 'nav'
                on_release: root.navigate_to('settings_tab')
            
            NavButton:
                icon_type: 'profile'
                group: 'nav'
                on_release: root.navigate_to('profile_tab')

<DiaryScreen>:
    name: "diary"
    on_enter: root.init_view()

    SwipeBox:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            spacing: 0
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                # Bottom Border
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1

            BoxLayout:
                orientation: "vertical"
                size_hint_x: 0.7
                padding: [0, 8]
                
                Label:
                    text: root.current_date_display_day
                    font_size: '11sp'
                    color: C_TEXT_SEC
                    bold: True
                    halign: 'left'
                    text_size: self.size
                    valign: 'bottom'
                
                Label:
                    text: root.current_date_display_date
                    font_size: '20sp'
                    bold: True
                    color: C_TEXT_MAIN
                    halign: 'left'
                    text_size: self.size
                    valign: 'top'

            BoxLayout:
                size_hint_x: None
                width: '60dp' # Reduced width since we only have one button now
                spacing: 10
                
                # Edit Questions Button (Pencil Icon)
                GhostButton:
                    text: u"\ue3c9" # Material Icon 'edit'
                    font_name: 'assets/MaterialIcons-Regular.ttf'
                    font_size: '28sp'
                    size_hint_x: 1
                    color: C_TEXT_SEC
                    on_release:
                        app.root.transition.direction = 'up'
                        app.root.current = 'editor'

        # Content
        ScreenManager:
            id: day_manager

#:import QuestionEditItem widgets.QuestionEditItem

<QuestionEditItem>:
    size_hint_y: None
    height: '60dp'
    padding: [15, 10]
    spacing: 15
    canvas.before:
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        Color:
            rgba: C_BORDER
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

    Label:
        text: root.text
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        color: C_TEXT_MAIN
        font_size: '15sp'
        shorten: True
        shorten_from: 'right'

    Button:
        text: ""
        size_hint_x: None
        width: '40dp'
        background_color: 0, 0, 0, 0
        background_normal: ''
        on_release: root.remove()
        canvas.after:
            Color:
                rgba: (0.8, 0.3, 0.3, 1)
            # Trash Bin Body
            Line:
                width: 1.2
                rounded_rectangle: (self.center_x - 6, self.center_y - 7, 12, 14, 2)
            # Lid
            Line:
                width: 1.2
                points: [self.center_x - 8, self.center_y + 9, self.center_x + 8, self.center_y + 9]
            # Handle/Knob
            Line:
                width: 1.2
                points: [self.center_x - 2, self.center_y + 9, self.center_x - 2, self.center_y + 11, self.center_x + 2, self.center_y + 11, self.center_x + 2, self.center_y + 9]
            # Vertical Lines details
            Line:
                width: 1
                points: [self.center_x - 2, self.center_y - 4, self.center_x - 2, self.center_y + 4]
            Line:
                width: 1
                points: [self.center_x + 2, self.center_y - 4, self.center_x + 2, self.center_y + 4]

<QuestionEditorScreen>:
    name: "editor"
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: "Cancel"
                size_hint_x: None
                width: '70dp'
                color: C_TEXT_SEC
                on_release: 
                    app.root.transition.direction = 'down'
                    app.root.current = 'home'

            Label:
                text: "Edit Questions"
                bold: True
                color: C_TEXT_MAIN
                font_size: '18sp'

            GhostButton:
                text: "Save"
                size_hint_x: None
                width: '70dp'
                color: C_BTN_OK
                bold: True
                on_release: root.prompt_save()

        # Add New Section
        BoxLayout:
            size_hint_y: None
            height: '80dp'
            padding: [20, 15]
            spacing: 15
            canvas.before:
                Color:
                    rgba: (0, 0, 0, 0.2)
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            TextInput:
                id: new_q_input
                hint_text: "Type a new question here..."
                hint_text_color: C_TEXT_SEC
                multiline: False
                background_normal: ''
                background_active: ''
                background_color: C_SURFACE
                foreground_color: C_TEXT_MAIN
                cursor_color: C_ACCENT
                padding: [15, 12]  # Center text vertically
                font_size: '15sp'
                size_hint_x: 0.8
                canvas.after:
                    Color:
                        rgba: C_BORDER
                    Line:
                        rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
                        width: 1

            Button:
                text: "+"
                size_hint_x: 0.2
                background_color: 0, 0, 0, 0
                background_normal: ''
                color: (1, 1, 1, 1)
                font_size: '24sp'
                bold: True
                canvas.before:
                    Color:
                        rgba: C_BTN_OK
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [6]
                on_release: root.add_question()

        ScrollView:
            size_hint_y: 1
            BoxLayout:
                id: q_list
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                padding: [20, 10]
                spacing: 12

<DayPage>:
    BoxLayout:
        ScrollView:
            id: scroll_view
            do_scroll_x: False
            bar_width: 0
            effect_cls: DampedScrollEffect
            
            GridLayout:
                id: grid_layout
                cols: 2
                spacing: 12
                padding: [15, 15, 15, 40]
                size_hint_y: None
                height: self.minimum_height

<DiaryEntryItemCard>:
    orientation: "vertical"
    size_hint_y: None
    height: 160
    padding: 15
    spacing: 10
    opacity: 1
    
    canvas.before:
        # Card Body
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        # Border
        Color:
            rgba: C_BORDER
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

    Label:
        text: root.question
        text_size: self.size
        halign: 'left'
        valign: 'top'
        color: C_TEXT_MAIN
        font_size: '13sp'
        bold: True
        size_hint_y: 0.35

    Label:
        text: root.answer if root.answer else "No content provided."
        text_size: self.size
        valign: 'top'
        halign: 'left'
        color: C_TEXT_SEC
        font_size: '12sp'
        line_height: 1.2
        size_hint_y: 0.65

<DetailScreen>:
    name: "detail"
    
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: "Back"
                size_hint_x: None
                width: '60dp'
                halign: 'left'
                color: C_TEXT_SEC
                on_release: root.save_and_close()

            Label:
                text: "Edit File"
                halign: 'center'
                valign: 'middle'
                color: C_TEXT_MAIN
                bold: True
                font_size: '16sp'

            GhostButton:
                text: "Commit"
                size_hint_x: None
                width: '70dp'
                color: C_BTN_OK
                bold: True
                on_release: root.save_and_close()
        
        ScrollView:
            BoxLayout:
                orientation: "vertical"
                padding: [20, 20, 20, 40]
                size_hint_y: None
                height: self.minimum_height
                spacing: 20

                Label:
                    text: root.question
                    text_size: (root.width - 40, None)
                    size_hint_y: None
                    height: self.texture_size[1]
                    halign: 'left'
                    color: C_TEXT_MAIN
                    font_size: '20sp'
                    bold: True
                    line_height: 1.2

                # Input container mimicking a code block
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: max(detail_input.minimum_height + 40, 300)
                    canvas.before:
                        Color:
                            rgba: C_SURFACE
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [6]
                        Color:
                            rgba: C_BORDER
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
                            width: 1

                    TextInput:
                        id: detail_input
                        text: root.answer
                        hint_text: "Type your code... I mean, thoughts."
                        hint_text_color: C_TEXT_SEC
                        multiline: True
                        background_color: 0, 0, 0, 0
                        foreground_color: C_TEXT_MAIN
                        cursor_color: C_ACCENT
                        font_size: '14sp'
                        font_name: 'Roboto' # or Courier if available?
                        line_height: 1.5
                        size_hint_y: 1
                        padding: [15, 15]
