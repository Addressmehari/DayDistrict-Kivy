#:set C_BG (0.05, 0.066, 0.09, 1)
#:set C_SURFACE (0.086, 0.105, 0.133, 1)
#:set C_BORDER (0.188, 0.211, 0.239, 1)
#:set C_ACCENT (0.345, 0.651, 1.0, 1)
#:set C_TEXT_MAIN (0.788, 0.82, 0.851, 1)
#:set C_TEXT_SEC (0.545, 0.58, 0.62, 1)
#:set C_BTN_OK (0.137, 0.525, 0.211, 1)

#:import DampedScrollEffect kivy.effects.dampedscroll.DampedScrollEffect
#:import SwipeBox widgets.SwipeBox
#:import DiaryEntryItemCard widgets.DiaryEntryItemCard
#:import WindowManager screens.WindowManager
#:import HomeScreen screens.HomeScreen
#:import DampedScrollEffect kivy.effects.dampedscroll.DampedScrollEffect
#:import SwipeBox widgets.SwipeBox
#:import DiaryEntryItemCard widgets.DiaryEntryItemCard
#:import WindowManager screens.WindowManager
#:import HomeScreen screens.HomeScreen
#:import DiaryScreen screens.DiaryScreen
#:import DetailScreen screens.DetailScreen
#:import QuestionEditorScreen screens.QuestionEditorScreen
#:import DayPage screens.DayPage
#:import ProfileScreen screens.ProfileScreen
#:import ProfileScreen screens.ProfileScreen
#:import MusicPlayerCard screens.MusicPlayerCard
#:import dp kivy.metrics.dp
#:import sp kivy.metrics.sp




<FlatButton@Button>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    color: 1, 1, 1, 1
    font_size: '16sp'
    bold: True
    canvas.before:
        Color:
            rgba: C_BTN_OK if self.state == 'normal' else (0.16, 0.58, 0.24, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        Color:
            rgba: (1, 1, 1, 0.1)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

<GhostButton@Button>:
    background_color: 0, 0, 0, 0
    background_normal: ''
    color: C_ACCENT
    font_size: '16sp'
    canvas.before:
        Color:
            rgba: (0.1, 0.1, 0.1, 0) # Transparent usually
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]

WindowManager:

    HomeScreen:
    QuestionEditorScreen:
    TagManagerScreen:
    DetailScreen:
    CalendarViewScreen:



#:import NavButton widgets.NavButton
#:import BottomNavBar widgets.BottomNavBar
#:import PlaceholderDisplay screens.PlaceholderDisplay
#:import CityMapScreen map_screen.CityMapScreen
#:import HomeDashboard screens.HomeDashboard
#:import StatCard widgets.StatCard
#:import RecentEntryItem widgets.RecentEntryItem
#:import HeatmapCell widgets.HeatmapCell
#:import CalendarViewScreen screens.CalendarViewScreen
#:import SearchResultItem widgets.SearchResultItem
#:import CalendarDayCell widgets.CalendarDayCell

<SearchResultItem>:
    size_hint_y: None
    height: '70dp'
    padding: [15, 10]
    canvas.before:
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8]
        Color:
            rgba: C_BORDER
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 8)
            width: 1
    
    BoxLayout:
        orientation: 'vertical'
        spacing: 4
        
        BoxLayout:
            spacing: 10
            Label:
                text: root.date_text
                font_size: '13sp'
                bold: True
                color: C_ACCENT
                size_hint_x: None
                width: self.texture_size[0]
                halign: 'left'
            
            Label:
                text: root.question_text
                font_size: '12sp'
                color: C_TEXT_SEC
                halign: 'left'
                text_size: self.size
                shorten: True
                shorten_from: 'right'

        Label:
            text: root.match_text
            font_size: '14sp'
            color: C_TEXT_MAIN
            halign: 'left'
            valign: 'top'
            text_size: self.size
            shorten: True
            shorten_from: 'right'

<NavButton>:
    orientation: 'vertical'
    size_hint_y: 1
    padding: [0, 8]
    
    # Icon Container using Material Icons Font
    Label:
        id: icon_d
        text: 
            {'home': u"\ue88a", 'map': u"\ue55b", 'settings': u"\ue8b8", 'profile': u"\ue7fd", 'center': u"\ue3c9"}.get(root.icon_type, "")
        font_name: 'assets/MaterialIcons-Regular.ttf'
        font_size: sp(root.icon_size)
        color: 
            (1, 1, 1, 1) if root.icon_type == 'center' else (C_ACCENT if root.state == 'down' else C_TEXT_SEC)
        size_hint: (None, None)
        size: ('40dp', '40dp')
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
        
        canvas.before:
            # CENTER FAB GLOW BACKGROUND
            Color:
                rgba: C_ACCENT if root.icon_type == 'center' else (0,0,0,0)
            Ellipse:
                pos: (self.center_x - dp(28), self.center_y - dp(28)) if root.icon_type == 'center' else (0,0)
                size: (dp(56), dp(56)) if root.icon_type == 'center' else (0,0)


<PlaceholderDisplay>:
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: root.text
            color: C_TEXT_SEC
            font_size: '20sp'

# ... (Previous definitions)

<WriteNowPrompter>:
    size_hint_y: None
    height: '0dp' # Default hidden, will animate/set to 70dp if needed
    opacity: 0
    padding: [20, 0]
    canvas.before:
        Color:
            rgba: (0.2, 0.6, 0.8, 0.15) # Subtle Blue Tint Background
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [12]
        Color:
            rgba: C_ACCENT
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
            width: 1
            dash_offset: 5
            dash_length: 5

    BoxLayout:
        spacing: 15
        
        # Icon Bulb/Pencil
        Label:
            text: u"\ue3c9" # Edit pencil
            font_name: 'assets/MaterialIcons-Regular.ttf'
            font_size: '28sp'
            color: C_ACCENT
            size_hint_x: None
            width: '40dp'
            pos_hint: {'center_y': 0.5}

        BoxLayout:
            orientation: 'vertical'
            pos_hint: {'center_y': 0.5}
            spacing: 2
            
            Label:
                text: "How is your day going?"
                font_size: '16sp'
                bold: True
                color: C_TEXT_MAIN
                text_size: self.size
                halign: 'left'
                valign: 'bottom'
            
            Label:
                text: "Tap to write your story..."
                font_size: '12sp'
                color: C_ACCENT
                text_size: self.size
                halign: 'left'
                valign: 'top'

<StatCard>:
    orientation: 'vertical'
    padding: [15, 12]
    spacing: 8
    size_hint_y: None
    height: '100dp'
    canvas.before:
        # --- Stencil Masking Start ---
        StencilPush
        
        # Define the Mask Shape (The Card Body)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
            
        StencilUse
        
        # --- Clipped Content ---
        # 1. Background
        Color:
            rgba: (1, 1, 1, 0.05)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]

        # 2. The Glow (Now safely clipped)
        Color:
            rgba: root.glow_color
        Ellipse:
            # Positioned at bottom-right corner, protruding out
            pos: self.right - dp(50), self.y - dp(30)
            size: dp(130), dp(130)
            angle_start: 0
            angle_end: 360
            
        # --- Stencil Cleanup ---
        StencilUnUse
        
        # Clear the stencil buffer (Draw mask again)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
            
        StencilPop
        # --- Stencil Masking End ---

        # 3. Border Stroke (Drawn on top)
        Color:
            rgba: root.stroke_color
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16)
            width: 1

    BoxLayout:
        size_hint_y: None
        height: '32dp'
        spacing: 10
        # Icon wrapper
        BoxLayout:
            size_hint_x: None
            width: '32dp'
            canvas.before:
                Color:
                    rgba: root.accent_color[:3] + [0.2]
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [8]
            Label:
                text: root.icon
                font_name: 'assets/MaterialIcons-Regular.ttf'
                font_size: '18sp'
                color: root.accent_color
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        # Title next to icon
        Label:
            text: root.title
            font_size: '13sp'
            color: C_TEXT_SEC
            text_size: self.size
            halign: 'left'
            valign: 'middle'
            bold: True

    Label:
        id: val_label
        text: root.value
        font_size: '28sp'
        bold: True
        color: C_TEXT_MAIN
        text_size: self.size
        halign: 'left'
        valign: 'middle'

<RecentEntryItem>:
    size_hint_y: None
    height: '60dp'
    padding: [15, 10]
    canvas.before:
        # Card Background
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10]
        # Subtle Border
        Color:
            rgba: (1, 1, 1, 0.05)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 10)
            width: 1
    
    BoxLayout:
        spacing: 15
        
        # Date Circle / Icon
        BoxLayout:
            size_hint_x: None
            width: '40dp'
            canvas.before:
                Color:
                    rgba: (0.15, 0.17, 0.20, 1) # Darker inner
                Ellipse:
                    pos: self.center_x - 20, self.center_y - 20
                    size: 40, 40
            
            Label:
                text: u"\ue865" # Book icon
                font_name: 'assets/MaterialIcons-Regular.ttf'
                font_size: '20sp'
                color: C_ACCENT
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        # Content Text
        BoxLayout:
            orientation: 'vertical'
            spacing: 2
            
            Label:
                text: root.date_text
                font_size: '14sp'
                bold: True
                color: C_TEXT_MAIN
                text_size: self.size
                halign: 'left'
                valign: 'bottom'
            
            Label:
                text: root.preview_text
                font_size: '13sp'
                color: C_TEXT_SEC
                text_size: self.size
                halign: 'left'
                valign: 'top'
                shorten: True
                shorten_from: 'right'
        
        # Arrow Right
        Label:
            text: u"\ue5cc"
            font_name: 'assets/MaterialIcons-Regular.ttf'
            font_size: '20sp'
            color: (0.3, 0.3, 0.3, 1)
            size_hint_x: None
            width: '20dp'

<HeatmapCell>:
    size_hint: (None, None)
    size: '12dp', '12dp'
    canvas.before:
        Color:
            rgba: root.color_val
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [2]

#:import WriteNowPrompter widgets.WriteNowPrompter

<HomeDashboard>:
    name: "home_tab"
    today_date: ""
    
    BoxLayout:
        orientation: 'vertical'
        padding: [20, 20, 20, 20]
        spacing: 20
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # --- Fixed Header Area (Greeting + Search) ---
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: '115dp' # 60 + 45 + spacing roughly
            spacing: 10
            
            # --- Greeting Header ---
            BoxLayout:
                size_hint_y: None
                height: '60dp'
                orientation: 'horizontal'
                
                BoxLayout:
                    orientation: 'vertical'
                    spacing: 2
                    Label:
                        id: greeting_label
                        text: "Good Morning,"
                        font_size: '16sp'
                        color: C_TEXT_SEC
                        text_size: self.size
                        halign: 'left'
                    Label:
                        text: root.date_display
                        font_size: '24sp'
                        bold: True
                        color: C_TEXT_MAIN
                        text_size: self.size
                        halign: 'left'

                # Profile Button
                Button:
                    size_hint: None, None
                    size: '50dp', '50dp'
                    background_color: 0,0,0,0
                    on_release: root.manager.current = 'profile_tab'
                    canvas.before:
                        Color:
                            rgba: C_SURFACE
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [25]
                        Color:
                            rgba: C_ACCENT
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 25)
                            width: 1
                    Label:
                        text: u"\ue853" # account_circle
                        font_name: 'assets/MaterialIcons-Regular.ttf'
                        font_size: '30sp'
                        color: C_ACCENT
                        center_x: self.parent.center_x
                        center_y: self.parent.center_y

            # --- Search Bar ---

            BoxLayout:
                size_hint_y: None
                height: '45dp'
                padding: [0, 0]
                
                TextInput:
                    id: search_input
                    hint_text: "Search entries..."
                    hint_text_color: C_TEXT_SEC
                    multiline: False
                    background_normal: ''
                    background_active: ''
                    background_color: C_SURFACE
                    foreground_color: C_TEXT_MAIN
                    cursor_color: C_ACCENT
                    padding: [15, 12]
                    font_size: '15sp'
                    on_text: root.perform_search(self.text)
                    canvas.after:
                        Color:
                            rgba: C_BORDER
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 8)
                            width: 1

        # --- Scrollable Content (Dashboard / Results) ---
        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            bar_width: 0
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 20
                padding: [0, 10, 0, 80] # Bottom padding for navbar space
                
                # --- Dashboard Content ---
                BoxLayout:
                    id: dashboard_content
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: 25
                    padding: [0, 10, 0, 80]
                    opacity: 1

                    # --- Write Now Prompter ---
                    WriteNowPrompter:
                        id: write_now_card
                        on_release: root.go_to_today()

                    # --- Heatmap Section ---
                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: '140dp'
                        spacing: 10
                        
                        BoxLayout:
                            size_hint_y: None
                            height: '30dp'
                            spacing: 10
                            
                            Label:
                                text: "Entry Graph"
                                font_size: '14sp'
                                color: C_TEXT_SEC
                                size_hint_x: 1
                                halign: 'left'
                                text_size: self.size
                                valign: 'middle'

                            BoxLayout:
                                size_hint_x: None
                                width: '120dp'
                                spacing: 5
                                
                                Button: # Prev Year
                                    text: "<"
                                    on_release: root.change_heatmap_year(-1)
                                    size_hint_x: None
                                    width: '30dp'
                                    background_color: 0,0,0,0
                                    color: C_ACCENT
                                    bold: True
                                
                                Label:
                                    text: str(root.heatmap_year)
                                    color: C_TEXT_MAIN
                                    bold: True
                                
                                Button: # Next Year
                                    text: ">"
                                    on_release: root.change_heatmap_year(1)
                                    size_hint_x: None
                                    width: '30dp'
                                    background_color: 0,0,0,0
                                    color: C_ACCENT
                                    bold: True

                        ScrollView:
                            do_scroll_x: True
                            do_scroll_y: False
                            size_hint_y: None
                            height: '110dp'
                            bar_width: 0
                            
                            BoxLayout:
                                id: heatmap_container
                                orientation: 'horizontal'
                                size_hint_x: None
                                width: self.minimum_width
                                spacing: 4
                                padding: [5, 5]

                    # --- Stats Section ---
                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height # Allow growing for Grid
                        spacing: 10
                        padding: [0, 10, 0, 0] # Add some top spacing

                        Label:
                            text: "Overview"
                            size_hint_y: None
                            height: '20dp'
                            font_size: '14sp'
                            color: C_TEXT_SEC
                            text_size: self.size
                            halign: 'left'
                        
                        GridLayout:
                            cols: 2
                            spacing: 15
                            size_hint_y: None
                            height: self.minimum_height
                            
                            StatCard:
                                id: stat_streak
                                title: "Streak"
                                icon: u"\ue52e" # fire
                                value: "0"
                                accent_color: (1.0, 0.6, 0.2, 1) # Orange

                            StatCard:
                                id: stat_total
                                title: "Total Entries"
                                icon: u"\ue865" # book
                                value: "0"
                                accent_color: (0.2, 0.8, 0.2, 1) # Green

                            StatCard:
                                id: stat_words
                                title: "Total Words"
                                icon: u"\ue0e5" # sms/comment
                                value: "0"
                                accent_color: (0.8, 0.4, 0.8, 1) # Purple

                            StatCard:
                                id: stat_active
                                title: "Active Day"
                                icon: u"\ue916" # date_range
                                value: "-"
                                accent_color: (0.4, 0.5, 1.0, 1) # Blue

                    # --- Upcoming / Recent Section ---
                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: 10
                        padding: [0, 10, 0, 0]

                        Label:
                            text: "Recent Entries"
                            size_hint_y: None
                            height: '20dp'
                            font_size: '14sp'
                            color: C_TEXT_SEC
                            text_size: self.size
                            halign: 'left'
                        
                        BoxLayout:
                            id: recent_list
                            orientation: 'vertical'
                            size_hint_y: None
                            height: self.minimum_height
                            spacing: 8
            
                # --- Search Results Container ---
                BoxLayout:
                    id: search_results_content
                    orientation: 'vertical'
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    spacing: 10
                    padding: [0, 10, 0, 80]
                    disabled: True
                    
                    Label:
                        text: "Search Results"
                        size_hint_y: None
                        height: '30dp'
                        font_size: '16sp'
                        color: C_TEXT_SEC
                        halign: 'left'
                        text_size: self.size
                        bold: True

                    BoxLayout:
                        id: search_results_list
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: 10



<HomeScreen>:
    name: "home"
    
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # Content Area
        ScreenManager:
            id: content_manager
            
            HomeDashboard:
                id: home_tab_screen
            
            CityMapScreen:
                name: "map_tab"
            
            DiaryScreen:
                name: "diary"

            PlaceholderDisplay:
                name: "settings_tab"
                text: "Settings\n(Coming Soon)"
            
            ProfileScreen:
                name: "profile_tab"


        # Bottom Navigation Bar
        BoxLayout:
            size_hint_y: None
            height: '80dp'
            padding: [15, 10, 15, 20] # Extra bottom padding for "floating" feel on mobile
            spacing: 0
            canvas.before:
                Color:
                    rgba: (0.086, 0.105, 0.133, 0.98) # Slight transparency C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: (1, 1, 1, 0.05) # Very subtle top highlight
                Line:
                    points: [self.x, self.y + self.height, self.width, self.y + self.height]
                    width: 1
            
            NavButton:
                icon_type: 'home'
                group: 'nav'
                state: 'down' # Default active
                on_release: root.navigate_to('home_tab')
            
            NavButton:
                icon_type: 'map'
                group: 'nav'
                on_release: root.navigate_to('map_tab')
            
            NavButton:
                icon_type: 'center'
                group: 'nav'
                size_hint_x: 1.2
                on_release: root.navigate_to('diary')

            NavButton:
                icon_type: 'settings'
                group: 'nav'
                on_release: root.navigate_to('settings_tab')
            
            NavButton:
                icon_type: 'profile'
                group: 'nav'
                on_release: root.navigate_to('profile_tab')

<DiaryScreen>:
    name: "diary"
    on_enter: root.init_view()

    SwipeBox:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size

        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            spacing: 0
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                # Bottom Border
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1

            BoxLayout:
                orientation: "vertical"
                size_hint_x: 0.7
                padding: [0, 8]
                
                Label:
                    text: root.current_date_display_day
                    font_size: '11sp'
                    color: C_TEXT_SEC
                    bold: True
                    halign: 'left'
                    text_size: self.size
                    valign: 'bottom'
                
                Label:
                    text: root.current_date_display_date
                    font_size: '20sp'
                    bold: True
                    color: C_TEXT_MAIN
                    halign: 'left'
                    text_size: self.size
                    valign: 'top'

            BoxLayout:
                size_hint_x: None
                width: '60dp' # Reduced width since we only have one button now
                spacing: 10
                
                # Tag Icon
                GhostButton:
                    text: u"\ue54e" # 'local_offer' tag icon
                    font_name: 'assets/MaterialIcons-Regular.ttf'
                    font_size: '22sp'
                    size_hint_x: 0.5
                    color: C_TEXT_SEC
                    on_release: 
                        # Get current page and open selector
                        root.ids.day_manager.current_screen.open_tag_selector()

                # Edit Questions Button (Pencil Icon)
                GhostButton:
                    text: u"\ue3c9" # Material Icon 'edit'
                    font_name: 'assets/MaterialIcons-Regular.ttf'
                    font_size: '22sp'
                    size_hint_x: 0.5
                    color: C_TEXT_SEC
                    on_release:
                        app.root.transition.direction = 'up'
                        app.root.current = 'editor'

        # Content
        ScreenManager:
            id: day_manager

#:import QuestionEditItem widgets.QuestionEditItem

<QuestionEditItem>:
    size_hint_y: None
    height: '60dp'
    padding: [15, 10]
    spacing: 15
    canvas.before:
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        Color:
            rgba: C_BORDER
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

    Label:
        text: root.text
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        color: C_TEXT_MAIN
        font_size: '15sp'
        shorten: True
        shorten_from: 'right'

    Button:
        text: ""
        size_hint_x: None
        width: '40dp'
        background_color: 0, 0, 0, 0
        background_normal: ''
        on_release: root.remove()
        canvas.after:
            Color:
                rgba: (0.8, 0.3, 0.3, 1)
            # Trash Bin Body
            Line:
                width: 1.2
                rounded_rectangle: (self.center_x - 6, self.center_y - 7, 12, 14, 2)
            # Lid
            Line:
                width: 1.2
                points: [self.center_x - 8, self.center_y + 9, self.center_x + 8, self.center_y + 9]
            # Handle/Knob
            Line:
                width: 1.2
                points: [self.center_x - 2, self.center_y + 9, self.center_x - 2, self.center_y + 11, self.center_x + 2, self.center_y + 11, self.center_x + 2, self.center_y + 9]
            # Vertical Lines details
            Line:
                width: 1
                points: [self.center_x - 2, self.center_y - 4, self.center_x - 2, self.center_y + 4]
            Line:
                width: 1
                points: [self.center_x + 2, self.center_y - 4, self.center_x + 2, self.center_y + 4]

<QuestionEditorScreen>:
    name: "editor"
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: "Cancel"
                size_hint_x: None
                width: '70dp'
                color: C_TEXT_SEC
                on_release: 
                    app.root.transition.direction = 'down'
                    app.root.current = 'home'

            Label:
                text: "Edit Questions"
                bold: True
                color: C_TEXT_MAIN
                font_size: '18sp'

            GhostButton:
                text: "Save"
                size_hint_x: None
                width: '70dp'
                color: C_BTN_OK
                bold: True
                on_release: root.prompt_save()
        
        # Tabs for Editor Switching
        BoxLayout:
            size_hint_y: None
            height: '40dp'
            spacing: 0
            padding: [20, 0]
            
            ToggleButton:
                text: "Questions"
                group: 'edit_mode'
                state: 'down'
                background_color: 0,0,0,0
                background_normal: ''
                color: C_ACCENT if self.state == 'down' else C_TEXT_SEC
                bold: True
                canvas.after:
                    Color:
                        rgba: C_ACCENT if self.state == 'down' else (0,0,0,0)
                    Line:
                        points: [self.x, self.y, self.right, self.y]
                        width: 2
            
            ToggleButton:
                text: "Tags"
                group: 'edit_mode'
                state: 'normal'
                background_color: 0,0,0,0
                background_normal: ''
                color: C_ACCENT if self.state == 'down' else C_TEXT_SEC
                bold: True
                on_release: 
                    app.root.transition.direction = 'left'
                    app.root.current = 'tag_manager' # Navigate to Tag Manager
                canvas.after:
                    Color:
                        rgba: C_ACCENT if self.state == 'down' else (0,0,0,0)
                    Line:
                        points: [self.x, self.y, self.right, self.y]
                        width: 2

        # Add New Section
        BoxLayout:
            size_hint_y: None
            height: '80dp'
            padding: [20, 15]
            spacing: 15
            canvas.before:
                Color:
                    rgba: (0, 0, 0, 0.2)
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            TextInput:
                id: new_q_input
                hint_text: "Type a new question here..."
                hint_text_color: C_TEXT_SEC
                multiline: False
                background_normal: ''
                background_active: ''
                background_color: C_SURFACE
                foreground_color: C_TEXT_MAIN
                cursor_color: C_ACCENT
                padding: [15, 12]  # Center text vertically
                font_size: '15sp'
                size_hint_x: 0.8
                canvas.after:
                    Color:
                        rgba: C_BORDER
                    Line:
                        rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
                        width: 1

            Button:
                text: "+"
                size_hint_x: 0.2
                background_color: 0, 0, 0, 0
                background_normal: ''
                color: (1, 1, 1, 1)
                font_size: '24sp'
                bold: True
                canvas.before:
                    Color:
                        rgba: C_BTN_OK
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [6]
                on_release: root.add_question()

        ScrollView:
            size_hint_y: 1
            BoxLayout:
                id: q_list
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                padding: [20, 10]
                spacing: 12

<CalendarDayCell>:
    size_hint_y: None
    height: self.width # Square cells
    canvas.before:
        Color:
            rgba: root.color_bg
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [4]
            
    Label:
        text: root.text
        bold: True
        font_size: '14sp'
        color: root.text_color
        pos_hint: {'center_x': 0.5, 'center_y': 0.5}

<CalendarViewScreen>:
    name: "calendar"
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: u"\ue5c4" # Arrow Back
                font_name: 'assets/MaterialIcons-Regular.ttf'
                font_size: '28sp'
                size_hint_x: None
                width: '50dp'
                halign: 'left'
                color: C_TEXT_MAIN
                on_release:
                    app.root.transition.direction = 'down'
                    app.root.current = 'home'

            Label:
                text: "Calendar View"
                halign: 'center'
                valign: 'middle'
                color: C_TEXT_MAIN
                bold: True
                font_size: '18sp'
                
            GhostButton:
                text: "Filter: " + ("All" if not root.filter_tags else str(len(root.filter_tags)) + " Selected")
                size_hint_x: None
                width: '130dp'
                font_size: '14sp'
                color: C_ACCENT
                on_release: root.open_filter_menu()
                bold: True
                
            # Spacer for symmetry
            Widget:
                size_hint_x: None
                width: '50dp'

        # Scrollable Content
        ScrollView:
            do_scroll_x: False
            
            BoxLayout:
                id: calendar_container
                orientation: 'vertical'
                padding: [20, 20]
                spacing: 20
                size_hint_y: None
                height: self.minimum_height

<TagManagerScreen>:
    name: "tag_manager"
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: "Back"
                size_hint_x: None
                width: '70dp'
                color: C_TEXT_SEC
                on_release: 
                    app.root.transition.direction = 'right'
                    app.root.current = 'editor' # Back to Questions

            Label:
                text: "Manage Tags"
                bold: True
                color: C_TEXT_MAIN
                font_size: '18sp'

            Widget: # Spacer
                size_hint_x: None
                width: '70dp'

        # Add New Section
        BoxLayout:
            size_hint_y: None
            height: '80dp'
            padding: [20, 15]
            spacing: 15
            canvas.before:
                Color:
                    rgba: (0, 0, 0, 0.2)
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            TextInput:
                id: new_tag_input
                hint_text: "New tag name..."
                hint_text_color: C_TEXT_SEC
                multiline: False
                background_normal: ''
                background_active: ''
                background_color: C_SURFACE
                foreground_color: C_TEXT_MAIN
                cursor_color: C_ACCENT
                padding: [15, 12]
                font_size: '15sp'
                size_hint_x: 0.8
                canvas.after:
                    Color:
                        rgba: C_BORDER
                    Line:
                        rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
                        width: 1

            Button:
                text: "+"
                size_hint_x: 0.2
                background_color: 0, 0, 0, 0
                background_normal: ''
                color: (1, 1, 1, 1)
                font_size: '24sp'
                bold: True
                canvas.before:
                    Color:
                        rgba: C_BTN_OK
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [6]
                on_release: root.add_tag()

        ScrollView:
            size_hint_y: 1
            BoxLayout:
                id: tag_list
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                padding: [20, 10]
                spacing: 12

<ChecklistItem>:
    size_hint_y: None
    height: '50dp'
    padding: [10, 0]
    spacing: 10
    canvas.before:
        Color:
            rgba: (1, 1, 1, 0.05)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]

    Label:
        id: icon
        text: u"\ue835" # Checkbox unchecked
        font_name: 'assets/MaterialIcons-Regular.ttf'
        font_size: '24sp'
        color: C_TEXT_SEC
        size_hint_x: None
        width: '40dp'
        
    Label:
        text: root.text
        color: C_TEXT_MAIN
        font_size: '16sp'
        halign: 'left'
        text_size: self.size
        valign: 'middle'

<TagSelectionModal>:
    BoxLayout:
        id: bg
        orientation: 'vertical'
        padding: 20
        spacing: 20
        canvas.before:
            Color:
                rgba: C_SURFACE
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [12]
            Color:
                rgba: C_BORDER
            Line:
                rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
                width: 1
        
        Label:
            text: "Select Tags"
            size_hint_y: None
            height: '30dp'
            font_size: '18sp'
            bold: True
            color: C_TEXT_MAIN
            
        ScrollView:
            BoxLayout:
                id: container
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 2
        
        Button:
            text: "Done"
            size_hint_y: None
            height: '40dp'
            background_color: 0,0,0,0
            background_normal: ''
            color: (1,1,1,1)
            on_release: root.dismiss()
            canvas.before:
                Color:
                    rgba: C_ACCENT
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [6]

<TagChip>:
    size_hint: None, None
    size: self.minimum_width, '32dp'
    padding: [12, 5, 5, 5]
    spacing: 5
    canvas.before:
        Color:
            rgba: (0.2, 0.4, 0.6, 0.4)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [16]
        Color:
            rgba: (0.2, 0.4, 0.6, 1)
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 16)
            width: 1
            
    Label:
        text: root.text
        size_hint_x: None
        width: self.texture_size[0]
        color: (0.8, 0.9, 1, 1)
        font_size: '13sp'
        bold: True
        
    Button:
        text: "x"
        size_hint: None, None
        size: '20dp', '20dp'
        background_color: 0,0,0,0
        background_normal: ''
        color: (1, 1, 1, 0.5)
        bold: True
        pos_hint: {'center_y': 0.5}
        on_release: root.remove()

<DayPage>:
    BoxLayout:
        orientation: "vertical"
        
        ScrollView:
            id: scroll_view
            do_scroll_x: False
            bar_width: 0
            effect_cls: DampedScrollEffect
            
            BoxLayout: # Wrapper
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                padding: [0, 0, 0, 40]
                spacing: 20
                
                GridLayout: # Questions
                    id: grid_layout
                    cols: 2
                    spacing: 12
                    padding: [15, 15]
                    size_hint_y: None
                    height: self.minimum_height

                # Tag Section
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [15, 0]
                    spacing: 10
                    
                    Label:
                        text: "Tags"
                        font_size: '14sp'
                        color: C_TEXT_SEC
                        size_hint_y: None
                        height: '24dp'
                        halign: 'left'
                        text_size: self.size
                        bold: True
                        opacity: 1 if len(tags_container.children) > 0 else 0
                        disabled: True if len(tags_container.children) == 0 else False
                    
                    StackLayout:
                        id: tags_container
                        orientation: 'lr-tb'
                        spacing: 8
                        padding: [5, 0]
                        size_hint_y: None
                        height: self.minimum_height

<DiaryEntryItemCard>:
    orientation: "vertical"
    size_hint_y: None
    height: 160
    padding: 15
    spacing: 10
    opacity: 1
    
    canvas.before:
        # Card Body
        Color:
            rgba: C_SURFACE
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [6]
        # Border
        Color:
            rgba: C_BORDER
        Line:
            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
            width: 1

    Label:
        text: root.question
        text_size: self.size
        halign: 'left'
        valign: 'top'
        color: C_TEXT_MAIN
        font_size: '13sp'
        bold: True
        size_hint_y: 0.35

    Label:
        text: root.answer if root.answer else "No content provided."
        text_size: self.size
        valign: 'top'
        halign: 'left'
        color: C_TEXT_SEC
        font_size: '12sp'
        line_height: 1.2
        size_hint_y: 0.65

<DetailScreen>:
    name: "detail"
    
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            GhostButton:
                text: "Back"
                size_hint_x: None
                width: '60dp'
                halign: 'left'
                color: C_TEXT_SEC
                on_release: root.save_and_close()

            Label:
                text: "Edit File"
                halign: 'center'
                valign: 'middle'
                color: C_TEXT_MAIN
                bold: True
                font_size: '16sp'

            GhostButton:
                text: "Commit"
                size_hint_x: None
                width: '70dp'
                color: C_BTN_OK
                bold: True
                on_release: root.save_and_close()
        
        ScrollView:
            BoxLayout:
                orientation: "vertical"
                padding: [20, 20, 20, 40]
                size_hint_y: None
                height: self.minimum_height
                spacing: 20

                Label:
                    text: root.question
                    text_size: (root.width - 40, None)
                    size_hint_y: None
                    height: self.texture_size[1]
                    halign: 'left'
                    color: C_TEXT_MAIN
                    font_size: '20sp'
                    bold: True
                    line_height: 1.2

                # Input container mimicking a code block
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: max(detail_input.minimum_height + 40, 300)
                    canvas.before:
                        Color:
                            rgba: C_SURFACE
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [6]
                        Color:
                            rgba: C_BORDER
                        Line:
                            rounded_rectangle: (self.x, self.y, self.width, self.height, 6)
                            width: 1

                    TextInput:
                        id: detail_input
                        text: root.answer
                        hint_text: "Type your code... I mean, thoughts."
                        hint_text_color: C_TEXT_SEC
                        multiline: True
                        background_color: 0, 0, 0, 0
                        foreground_color: C_TEXT_MAIN
                        cursor_color: C_ACCENT
                        font_size: '14sp'

                        line_height: 1.5
                        size_hint_y: 1
                        padding: [15, 15]
<TagFilterModal>:
    BoxLayout:
        id: bg
        orientation: 'vertical'
        padding: 20
        spacing: 20
        canvas.before:
            Color:
                rgba: C_SURFACE
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [12]
            Color:
                rgba: C_BORDER
            Line:
                rounded_rectangle: (self.x, self.y, self.width, self.height, 12)
                width: 1
        
        Label:
            text: "Filter Tags"
            size_hint_y: None
            height: '30dp'
            font_size: '18sp'
            bold: True
            color: C_TEXT_MAIN
            
        ScrollView:
            BoxLayout:
                id: container
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 2
        
        Button:
            text: "Close"
            size_hint_y: None
            height: '40dp'
            background_color: 0,0,0,0
            background_normal: ''
            color: (1,1,1,1)
            on_release: root.dismiss()
            canvas.before:
                Color:
                    rgba: C_ACCENT
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [6]

<ProfileScreen>:
    name: "profile"
    BoxLayout:
        orientation: "vertical"
        canvas.before:
            Color:
                rgba: C_BG
            Rectangle:
                pos: self.pos
                size: self.size
        
        # Header
        BoxLayout:
            size_hint_y: None
            height: '60dp'
            padding: [15, 0]
            canvas.before:
                Color:
                    rgba: C_SURFACE
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: C_BORDER
                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1

                Line:
                    points: [self.x, self.y, self.width, self.y]
                    width: 1
            
            Label:
                text: "My Profile"
                halign: 'center'
                valign: 'middle'
                color: C_TEXT_MAIN
                bold: True
                font_size: '20sp'


        ScrollView:
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                
                # --- SECTION 1: HEADER (Cover + Avatar) ---
                RelativeLayout:
                    size_hint_y: None
                    height: '240dp' # 180 cover + 60 overlap space
                    
                    # Cover Image (Favorite Photo)
                    AsyncImage:
                        source: root.fav_photo_source
                        pos_hint: {'top': 1}
                        size_hint: 1, None
                        height: '180dp'
                        fit_mode: "cover"

                    # Edit Cover Button
                    Button:
                        text: "Edit Cover"
                        font_size: '11sp'
                        size_hint: None, None
                        size: '80dp', '28dp'
                        pos_hint: {'right': 0.95, 'top': 0.96}
                        background_color: 0,0,0,0
                        on_release: root.choose_image('favorite_photo')
                        canvas.before:
                            Color:
                                rgba: (0,0,0,0.5)
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [14]
                    
                    # Avatar (Overlapping)
                    BoxLayout:
                        size_hint: None, None
                        size: '120dp', '120dp'
                        pos: '20dp', '0dp' # Bottom-left relative to container. 
                        # Container height=240. Cover=180 (top). Cover bot=60.
                        # We want avatar center on 60. so y=0 is center 60.
                        # Wait, y=0. Height 120. Center=60. Perfect.
                        
                        # Avatar Circle Stencil
                        canvas.before:
                            StencilPush
                            Ellipse:
                                pos: self.pos
                                size: self.size
                            StencilUse
                        
                        canvas.after:
                            StencilUnUse
                            Ellipse:
                                pos: self.pos
                                size: self.size
                            StencilPop
                            # Outline (Dark BG color to separate from cover)
                            Color:
                                rgba: C_BG
                            Line:
                                circle: (self.center_x, self.center_y, self.width/2)
                                width: 4
                        
                        AsyncImage:
                            source: root.pfp_source
                            size_hint: 1, 1
                            fit_mode: "cover"
                        
                    # Edit PFP Button (Invisible overlay or small icon?)
                    # Let's put a small button next to avatar or make avatar clickable?
                    # Be explicit with a badge or button.
                    Button:
                        text: "+"
                        size_hint: None, None
                        size: '30dp', '30dp'
                        pos: '90dp', '10dp' # Relative to container
                        background_color: 0,0,0,0
                        on_release: root.choose_image('profile_pic')
                        canvas.before:
                            Color:
                                rgba: C_ACCENT
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [15]

                # --- SECTION 2: IDENTITY ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [25, 10, 25, 20]
                    spacing: 5
                    
                    # Name
                    TextInput:
                        text: root.username
                        multiline: False
                        background_normal: ''
                        background_active: ''
                        background_color: 0,0,0,0
                        foreground_color: C_TEXT_MAIN
                        cursor_color: C_ACCENT
                        font_size: '26sp'
                        bold: True
                        halign: 'left'
                        hint_text: "Your Name"
                        hint_text_color: C_TEXT_SEC
                        size_hint_y: None
                        height: '40dp'
                        padding: [0, 5]
                        write_tab: False
                        on_text_validate: root.save_field('username', self.text)
                    
                    # Info Row (Date)
                    BoxLayout:
                        size_hint_y: None
                        height: '20dp'
                        spacing: 10
                        Label:
                            text: u"\ue916" # Date range icon
                            font_name: 'assets/MaterialIcons-Regular.ttf'
                            font_size: '14sp'
                            color: C_TEXT_SEC
                            size_hint_x: None
                            width: self.texture_size[0]
                        Label:
                            text: root.joined_date
                            font_size: '13sp'
                            color: C_TEXT_SEC
                            halign: 'left'
                            text_size: self.size
                    
                    # Bio
                    TextInput:
                        id: bio_input_ref
                        text: root.bio
                        multiline: True
                        background_normal: ''
                        background_active: ''
                        background_color: 0,0,0,0
                        foreground_color: (0.8, 0.8, 0.8, 1)
                        cursor_color: C_ACCENT
                        font_size: '14sp'
                        size_hint_y: None
                        height: '80dp' # Fixed height for bio block
                        padding: [0, 10]
                        line_height: 1.3
                        hint_text: "Passionate about..."
                        hint_text_color: C_TEXT_SEC
                        on_text: root.save_field('bio', self.text) # Auto save on typing? or validate

                # --- SECTION 3: GENERAL SETTINGS (Card) ---
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [20, 10]
                    spacing: 10
                    
                    Label:
                        text: "General"
                        font_size: '16sp'
                        bold: True
                        color: C_TEXT_MAIN
                        halign: 'left'
                        text_size: self.size
                        size_hint_y: None
                        height: '30dp'

                    # Card Container
                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_y: None
                        height: self.minimum_height
                        canvas.before:
                            Color:
                                rgba: C_SURFACE
                            RoundedRectangle:
                                pos: self.pos
                                size: self.size
                                radius: [14]
                        
                        # Row 1: Music Player Card (Big & Glossy)
                        MusicPlayerCard:
                            is_playing: root.is_playing
                            size_hint_y: None
                            height: '110dp' # Big
                            padding: [15, 15]
                            spacing: 15
                            
                            canvas.before:
                                # Glass Background
                                Color:
                                    rgba: (0.12, 0.12, 0.14, 0.7) 
                                RoundedRectangle:
                                    pos: self.pos
                                    size: self.size
                                    radius: [16]
                                
                                # Glow Border (Animated)
                                Color:
                                    rgba: C_ACCENT[0], C_ACCENT[1], C_ACCENT[2], self.glow_alpha
                                Line:
                                    rounded_rectangle: (self.x, self.y, self.width, self.height, 16)
                                    width: 2
                                
                                # Static Subtle Border (Glossy Edge)
                                Color:
                                    rgba: (1, 1, 1, 0.1)
                                Line:
                                    rounded_rectangle: (self.x, self.y, self.width, self.height, 16)
                                    width: 1

                            # Album Art (Dynamic & Big)
                            BoxLayout:
                                size_hint: None, None
                                size: '80dp', '80dp'
                                canvas.before:
                                    Color:
                                        rgba: (0,0,0,0)
                                    RoundedRectangle:
                                        pos: self.pos
                                        size: self.size
                                        radius: [12]
                                
                                # Use AsyncImage for extracted cover or fallback icon
                                AsyncImage:
                                    source: root.music_cover if root.music_cover else ""
                                    size_hint: 1, 1
                                    fit_mode: "cover"
                                    opacity: 1 if root.music_cover else 0
                                    radius: [12] # If canvas instructions inside AsyncImage don't clip, we might need fitimage or stencil. 
                                    # AsyncImage usually doesn't clip by radius directly unless FitImage.
                                    # But FitImage was removed.
                                    # Let's simple use stencil trick again if needed or just square. 
                                    # 80dp is big. Let's try to fit.
                                
                                # Fallback Icon
                                Label:
                                    text: u"\ue405" # Queue Music Icon
                                    font_name: 'assets/MaterialIcons-Regular.ttf'
                                    font_size: '40sp'
                                    color: C_ACCENT
                                    opacity: 0 if root.music_cover else 1
                                    pos_hint: {'center_x': 0.5, 'center_y': 0.5}

                            # Info (Metadata)
                            BoxLayout:
                                orientation: 'vertical'
                                valign: 'middle'
                                padding: [5, 5]
                                spacing: 4
                                
                                # Song Title
                                Label:
                                    text: root.music_title if root.music_path else "My Anthem"
                                    font_size: '18sp'
                                    bold: True
                                    color: C_TEXT_MAIN
                                    halign: 'left'
                                    text_size: self.size
                                    size_hint_y: None
                                    height: '24dp'
                                    shorten: True
                                    shorten_from: 'right'
                                
                                # Artist
                                Label:
                                    text: root.music_artist if root.music_path else "Select a track"
                                    font_size: '14sp'
                                    color: C_TEXT_SEC
                                    halign: 'left'
                                    text_size: self.size
                                    size_hint_y: None
                                    height: '18dp'
                                    shorten: True
                                    shorten_from: 'right'
                                
                                # Visualizer / Status
                                Label:
                                    text: "Now Playing..." if root.is_playing else "Tap play to listen"
                                    font_size: '11sp'
                                    color: C_ACCENT
                                    halign: 'left'
                                    text_size: self.size
                                    size_hint_y: None
                                    height: '14dp'
                                    opacity: 0.8

                            # Controls
                            BoxLayout:
                                size_hint_x: None
                                width: '50dp'
                                orientation: 'vertical'
                                spacing: 10
                                valign: 'center'
                                
                                # Play Button (Centred and Big)
                                Button:
                                    text: u"\ue034" if root.is_playing else u"\ue037"
                                    font_name: 'assets/MaterialIcons-Regular.ttf'
                                    font_size: '36sp'
                                    background_color: 0,0,0,0
                                    color: C_ACCENT
                                    on_release: root.toggle_music()
                                    size_hint: 1, None
                                    height: '50dp'
                                
                                # Upload Mini Button
                                Button:
                                    text: u"\ue2c6" # file_upload
                                    font_name: 'assets/MaterialIcons-Regular.ttf'
                                    font_size: '20sp'
                                    background_color: 0,0,0,0
                                    color: C_TEXT_SEC
                                    on_release: root.choose_file('music_path', 'audio')
                                    size_hint: 1, None
                                    height: '30dp'
                                    opacity: 0.7

                        # Divider
                        Widget:
                            size_hint_y: None
                            height: 1
                            canvas.before:
                                Color:
                                    rgba: (1,1,1,0.05)
                                Rectangle:
                                    pos: self.x + 50, self.y
                                    size: self.width - 50, 1

                        # Row 2: Terms / Info (Filler to match look)
                        BoxLayout: # Dummy row or redundant info? 
                            # User said "add about and things ive told".
                            # I have Music and Bio. I used Photo as cover.
                            # I can put "Edit Profile" link?
                            size_hint_y: None
                            height: '60dp'
                            padding: [15, 0]
                            spacing: 15
                            
                            Label:
                                text: u"\ue887" # Info
                                font_name: 'assets/MaterialIcons-Regular.ttf'
                                font_size: '22sp'
                                color: C_TEXT_SEC
                                size_hint_x: None
                                width: '30dp'
                             
                            Label:
                                text: "App Version 1.0"
                                font_size: '14sp'
                                color: C_TEXT_MAIN
                                halign: 'left'
                                text_size: self.size
                                valign: 'middle'

                            Label:
                                text: ">"
                                font_size: '16sp'
                                color: (0.3, 0.3, 0.3, 1)
                                size_hint_x: None
                                width: '20dp'


